import pandas as pd
from jinja2 import Environment, FileSystemLoader
import os
from weasyprint import HTML
from openpyxl import Workbook
from openpyxl.utils.dataframe import dataframe_to_rows

# --- 設定 ---
# Streamlit Cloud 上で templates フォルダを読み込む設定
TEMPLATE_DIR = "templates"
env = Environment(loader=FileSystemLoader(TEMPLATE_DIR))

# 改行コードをHTMLの<br>に変換するフィルタ（テキストエリアの入力を反映させるため）
def nl2br(value):
    return value.replace('\n', '<br>') if value else ""
env.filters['nl2br'] = nl2br

# --- 計算補助関数 ---
def calculate_loan_schedule(principal, rate_annual, term_months):
    """毎月の利息と元金の返済スケジュールを計算"""
    if rate_annual == 0:
        return [{'interest': 0, 'principal': principal / term_months}] * term_months
    
    rate_monthly = rate_annual / 100 / 12
    monthly_payment = principal * rate_monthly / (1 - (1 + rate_monthly)**(-term_months))
    
    schedule = []
    current_balance = principal
    for _ in range(term_months):
        interest = current_balance * rate_monthly
        principal_payment = monthly_payment - interest
        current_balance -= principal_payment
        schedule.append({'interest': interest, 'principal': principal_payment})
    return schedule

# --- メイン生成関数 ---
def generate_plan_documents(data, output_dir):
    """
    data: st.session_state.plan_data (dict)
    output_dir: ファイルの保存先（Cloud環境では 'output' など）
    """
    os.makedirs(output_dir, exist_ok=True)
    
    # 1. 収支計算の精緻化 (10年分)
    proj_df = data['projection_data'].copy()
    
    # 借入金利息の計算
    loan_schedule = calculate_loan_schedule(data['loan_request'], data['loan_rate'], data['loan_term'])
    
    annual_interest = []
    for year in range(1, 11):
        start = (year - 1) * 12
        end = year * 12
        # 借入期間が終わっている場合は0
        year_interest = sum(d['interest'] for d in loan_schedule[start:end]) if start < len(loan_schedule) else 0
        annual_interest.append(year_interest)
    
    proj_df['支払利息'] = annual_interest
    
    # 減価償却費の計算（設備資金を7年定額法で計算する簡易例）
    depreciation_annual = data['equip_cost'] / 7 if data['equip_cost'] > 0 else 0
    proj_df['減価償却費'] = [int(depreciation_annual) if i < 7 else 0 for i in range(10)]

    # 利益計算
    proj_df['売上総利益'] = proj_df['売上高'] - proj_df['売上原価']
    proj_df['販管費'] = proj_df['人件費'] + proj_df['家賃'] + proj_df['その他経費']
    proj_df['営業利益'] = proj_df['売上総利益'] - proj_df['販管費']
    proj_df['経常利益'] = proj_df['営業利益'] - proj_df['支払利息']
    proj_df['当期純利益'] = proj_df['経常利益'].apply(lambda x: int(x * 0.7) if x > 0 else x) # 簡易税率30%
    
    # 数値を整頓
    proj_df = proj_df.astype(int)

    # 2. 創業計画書 (メイン) PDF生成
    main_template = env.get_template('main_plan_template.html')
    main_html = main_template.render(data=data, total_needed=data['equip_cost'] + data['operate_cost'])
    main_pdf_path = os.path.join(output_dir, "創業計画書_メイン.pdf")
    # Streamlit Cloud (Linux) で日本語フォントを適用するため、CSSで 'IPAexGothic' を指定すること
    HTML(string=main_html).write_pdf(main_pdf_path)

    # 3. 事業の見通し (収支計画) PDF生成
    proj_template = env.get_template('projection_template.html')
    # 10年分のデータをHTMLテーブル化して渡す
    proj_html_table = proj_df.to_html(classes='table', formatters={col: lambda x: f"¥{x:,.0f}" for col in proj_df.columns})
    proj_html = proj_template.render(table_html=proj_html_table)
    proj_pdf_path = os.path.join(output_dir, "事業の見通し_収支計画.pdf")
    HTML(string=proj_html